/***************************************************************************
 *   Copyright (C) 2013 by James Holodnak                                  *
 *   jamesholodnak@gmail.com                                               *
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 *   This program is distributed in the hope that it will be useful,       *
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
 *   GNU General Public License for more details.                          *
 *                                                                         *
 *   You should have received a copy of the GNU General Public License     *
 *   along with this program; if not, write to the                         *
 *   Free Software Foundation, Inc.,                                       *
 *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
 ***************************************************************************/

#include "palette/palette.h"
#include <stdio.h>
#include "system/video.h"
#if 0
#include <stdlib.h>
#include <string.h>
#include "misc/memutil.h"
#include "misc/strutil.h"
#include "misc/log.h"
#include "misc/config.h"
#include "palette/generator.h"
#include "misc/paths.h"
#endif

static palette_t pal = {{
{
  0x00666666,0x00723700,0x00a51d00,0x00ad003d,0x00850060,0x00420073,0x00000571,0x00001d5a,
  0x00003634,0x00004b0a,0x00005500,0x00055200,0x002b4b00,0x00000000,0x00000000,0x00000000,
  0x00afafaf,0x00e6600f,0x00ff3e41,0x00ff2378,0x00d815a7,0x007f1ac1,0x001c2ebe,0x00004e9f,
  0x0000706d,0x00008c36,0x00009907,0x002f9500,0x00618c00,0x00000000,0x00000000,0x00000000,
  0x00ffffff,0x00ffc14b,0x00ff9e75,0x00ff72c9,0x00ff64f8,0x00cf68ff,0x009d71ff,0x00169ef0,
  0x0000c0be,0x0000dc85,0x0024e956,0x007ee53c,0x00e3d03f,0x004e4e4e,0x00000000,0x00000000,
  0x00ffffff,0x00ffe6b5,0x00ffd7c7,0x00ffcadd,0x00ffc1f3,0x00ecc1ff,0x00d7c5ff,0x00afd0ff,
  0x008ce5e4,0x008becd9,0x0098f5c2,0x00caf5af,0x00dff1ae,0x00b6b6b6,0x00000000,0x00000000,
},
{
  0x004a3f6b,0x00660f00,0x008a000e,0x00890037,0x00760052,0x0039006d,0x00000072,0x00000461,
  0x0000114a,0x00002523,0x00003200,0x00003300,0x00281f00,0x00000000,0x00000000,0x00000000,
  0x008979b6,0x00b1370f,0x00dd1f3b,0x00dd0b6f,0x00c50394,0x007306b9,0x004010c5,0x00002ca8,
  0x00003e89,0x00005855,0x00006921,0x00006a00,0x003c5600,0x00000002,0x00000000,0x00000000,
  0x00cfbaff,0x00fa785f,0x00ff569f,0x00ff4ac2,0x00ff43e0,0x00bd46ff,0x00854fff,0x001d6cfb,
  0x000083d5,0x00009f9c,0x0000a284,0x0031ae41,0x00809744,0x00362c53,0x00000000,0x00000000,
  0x00cfbaff,0x00e99cc4,0x00f093d9,0x00fe8ee2,0x00d08dfc,0x00d589ff,0x00b08eff,0x008b99ff,
  0x0070a4f2,0x0061afde,0x0066b3ce,0x0071bab8,0x00afabb8,0x00907fbe,0x00000000,0x00000000,
},
{
  0x00215e3d,0x003d3000,0x006b1600,0x00790009,0x00490031,0x0017004a,0x0000004d,0x0000153b,
  0x00002927,0x00004300,0x00005300,0x00004d00,0x00004300,0x00000000,0x00000000,0x00000000,
  0x0050a577,0x00776600,0x00b44401,0x00c71f37,0x00850d67,0x003e1089,0x0000248c,0x00004375,
  0x00005d5b,0x00008024,0x00009600,0x00008e00,0x00238100,0x00000000,0x00000000,0x00000000,
  0x0084f2b7,0x00c0ae23,0x00cf9d32,0x00ff6878,0x00cf5c9a,0x00735bcb,0x00097bc0,0x000091b3,
  0x0000a5a2,0x0000cb67,0x0000e42d,0x001ddb20,0x0066cb18,0x0011482a,0x00000000,0x00000000,
  0x0084f2b7,0x009dd877,0x00abce7f,0x00c6bf8e,0x00a3b4ab,0x0078b3c3,0x0059bebd,0x0047c3c1,
  0x003cd89f,0x002fde9e,0x0050ee78,0x0058e87c,0x007be176,0x0055ac7d,0x00000000,0x00000000,
},
{
  0x001a3f47,0x00371700,0x00620200,0x00690018,0x004b0031,0x0021004a,0x0000004d,0x0000053d,
  0x00001d1b,0x0000240e,0x00002f00,0x00003100,0x00082300,0x00000000,0x00000000,0x00000000,
  0x00417e7d,0x006e4400,0x00a8280b,0x00b00946,0x008a0067,0x00520088,0x0000198c,0x00002d77,
  0x00004c4a,0x00005639,0x00006517,0x00006800,0x00295600,0x00000000,0x00000000,0x00000000,
  0x0071c0bf,0x00978925,0x00e5674b,0x00e6458e,0x00c73fa5,0x00933ccb,0x000d5bcd,0x00006cbb,
  0x00008d8a,0x00009974,0x0000a854,0x001ca922,0x00569723,0x00082f2f,0x00000000,0x00000000,
  0x0071c0bf,0x00aba678,0x00d3938d,0x00d086a7,0x00b484b7,0x007e87ca,0x004896c6,0x003a9fba,
  0x002eaaa9,0x002eaaa9,0x002cb398,0x0050b77d,0x0077ae7c,0x004b808b,0x00000000,0x00000000,
},
{
  0x007d4b40,0x008b2000,0x00ac1500,0x00b2001e,0x009d0032,0x006c004b,0x002a0053,0x00000045,
  0x00001716,0x00002e00,0x00003b00,0x000f3a00,0x00433500,0x00000000,0x00000000,0x00000000,
  0x00cf8a7b,0x00e15200,0x00ff4214,0x00ff1d4e,0x00f90f69,0x00b7048a,0x005e0a95,0x0000237f,
  0x00004544,0x00006514,0x00007400,0x003a7400,0x00806d00,0x000b0000,0x00000000,0x00000000,
  0x00ffd0bc,0x00ff9839,0x00ff7275,0x00ff628e,0x00ff50b2,0x00ff47d4,0x00d94ad0,0x004667c4,
  0x001a8887,0x0010ab53,0x0061b729,0x0097b81e,0x00cab61c,0x0063372d,0x00000000,0x00000000,
  0x00ffd0bc,0x00ffbe82,0x00ffb291,0x00ffa4a6,0x00ff9bb9,0x00ff96c7,0x00ff97ca,0x00dc9acd,
  0x00bdafac,0x00b2c38c,0x00cfc682,0x00d6cc79,0x00ffbc86,0x00d79181,0x00000000,0x00000000,
},
{
  0x005e3049,0x00610e00,0x008f0009,0x00890022,0x007a0034,0x0051004a,0x00270054,0x00000041,
  0x00000922,0x00001908,0x00002a00,0x00002700,0x00261c00,0x00000000,0x00000000,0x00000000,
  0x00a56688,0x00a73900,0x00e51532,0x00dc0554,0x00ab007f,0x00920089,0x005a0096,0x00001d7c,
  0x00003057,0x00004731,0x00005d00,0x00115a00,0x00584b00,0x00000000,0x00000000,0x00000000,
  0x00f3a0cd,0x00eb7833,0x00ff4d7a,0x00ff4195,0x00f334c3,0x00d333d0,0x009c38dc,0x002157c1,
  0x0006689d,0x00007f7d,0x00139b35,0x00649522,0x00978925,0x00481f35,0x00000000,0x00000000,
  0x00f3a0cd,0x00f28e90,0x00ff7daf,0x00fc78bc,0x00e775ca,0x00e775ca,0x00ce75d4,0x009282cd,
  0x007890b6,0x005da1a0,0x0061ab8a,0x0093ab76,0x00b6a27a,0x00ac6b8e,0x00000000,0x00000000,
},
{
  0x00494528,0x00492100,0x006d1200,0x007f000c,0x005f0024,0x003d0037,0x00010040,0x0000012d,
  0x00001412,0x00002900,0x00003900,0x00003600,0x00123000,0x00000000,0x00000000,0x00000000,
  0x007a8658,0x00885200,0x00b83e00,0x00cf1136,0x00a70452,0x0077006f,0x0027087b,0x00002861,
  0x0000403e,0x00005d16,0x00007200,0x00116d00,0x006c5a00,0x00000000,0x00000000,0x00000000,
  0x00bbcb8f,0x00d39119,0x00ff7d2d,0x00ff526f,0x00eb4787,0x00c73fa5,0x006648b8,0x00006d97,
  0x00007f7d,0x00009e54,0x001fb516,0x004db10d,0x007ea80b,0x002c3417,0x00000000,0x00000000,
  0x00bbcb8f,0x00beb360,0x00d9ab67,0x00ec9585,0x00d68b9c,0x00c284b2,0x009e86bb,0x006698ac,
  0x005ba39b,0x005eb974,0x0084bf5e,0x009ebb5d,0x00a1ba5d,0x00808d5e,0x00000000,0x00000000,
},
{
  0x00353535,0x00540900,0x006e0000,0x006b0016,0x004c0031,0x001a003f,0x0000003e,0x00000037,
  0x00001210,0x00002100,0x00002900,0x00002600,0x00092100,0x00000000,0x00000000,0x00000000,
  0x006c6c6c,0x00953100,0x00b71719,0x00b30343,0x008b0066,0x00480079,0x00000c77,0x00002360,
  0x00003d3b,0x00005211,0x00005c00,0x000c5800,0x00325200,0x00000000,0x00000000,0x00000000,
  0x00a8a8a8,0x00b67a21,0x00e86041,0x00f8476a,0x00e13793,0x008437b6,0x005e3eb8,0x00005f9d,
  0x00007977,0x00008e4d,0x00049829,0x00489516,0x006e8e14,0x00232323,0x00000000,0x00000000,
  0x00a8a8a8,0x00ae9571,0x00c38a7e,0x00c9808f,0x00c07a9f,0x00a878ab,0x008a7daf,0x006c85a9,
  0x0057909c,0x00549e83,0x005ba07b,0x0072a26f,0x00a09a6d,0x00727272,0x00000000,0x00000000,
}
}};

#if 0
/* measurement by Quietust */
static const double emphasis_factor[8][3]={
   {1.00, 1.00, 1.00},
   {1.00, 0.80, 0.81},
   {0.78, 0.94, 0.66},
   {0.79, 0.77, 0.63},
   {0.82, 0.83, 1.12},
   {0.81, 0.71, 0.87},
   {0.68, 0.79, 0.79},
   {0.70, 0.70, 0.70}
};

static void generate_emphasis(palette_t *p)
{
	int i,j;

	for(j=1;j<8;j++) {
		for(i=0;i<64;i++) {
			p->pal[j][i].r = (u8)((double)p->pal[0][i].r * emphasis_factor[j][0]);
			p->pal[j][i].g = (u8)((double)p->pal[0][i].g * emphasis_factor[j][1]);
			p->pal[j][i].b = (u8)((double)p->pal[0][i].b * emphasis_factor[j][2]);
		}
	}
}

void palette_destroy(palette_t *p)
{
	mem_free(p);
}

palette_t *palette_load(char *filename)
{
	palette_t *ret = 0;
	FILE *fp;
	u8 colors[3];
	int i;

	if((fp = fopen(filename,"rb")) == 0) {
		log_printf("palette_load:  error opening '%s'\n",filename);
		return(0);
	}
	ret = palette_create();
	for(i=0;i<64;i++) {
		fread(colors,1,3,fp);
		if(feof(fp)) {
			log_printf("palette_load:  unexpected end of file in '%s'\n",filename);
			palette_destroy(ret);
			ret = 0;
			break;
		}
		ret->pal[0][i].r = colors[0];
		ret->pal[0][i].g = colors[1];
		ret->pal[0][i].b = colors[2];
	}
	fclose(fp);
	generate_emphasis(ret);
	log_printf("palette_load:  loaded palette '%s'\n",filename);
	return(ret);
}

int palette_save(char *filename,palette_t *p)
{
	//not implemented yet
	return(1);
}

void palette_kill()
{
	palette_destroy(pal);
}

palette_t *palette_create()
{
	palette_t *ret = 0;

	ret = (palette_t*)mem_alloc(sizeof(palette_t));
	memset(ret,0,sizeof(palette_t));
	return(ret);
}

int palette_init()
{
	char file[1024];

	//clear the string
	memset(file,0,1024);

	//parse the bios path
	config_get_eval_string(file,"path.palette");

	//append the path seperator
	str_appendchar(file,PATH_SEPERATOR);

	//append the bios filename
	strcat(file,config_get_string("palette.filename"));

	if(strcmp(config_get_string("palette.source"),"file") == 0) {
		pal = palette_load(file);
	}
	if(pal == 0) {
		pal = palette_generate(config_get_int("palette.hue"),config_get_int("palette.saturation"));
	}
	video_setpalette(&pal);

	return(0);
}

#endif

palette_t *palette_load(char *filename) { return NULL; }
int palette_save(char *filename,palette_t *p) {return 1; }
int palette_init() {
	video_setpalette(&pal);
  return 0;
}
void palette_kill() { }
